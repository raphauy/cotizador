# Informe de Cambios - Error de Hidratación React
**Fecha:** 2025-01-30
**Ambiente:** Producción
**Problema:** Error esporádico de hidratación React #423 al ingresar medidas rápidamente

## Resumen Ejecutivo
Se corrigió un error crítico de hidratación que ocurría cuando usuarios ingresaban datos rápidamente usando TAB. El error principal era causado por usar índices como keys en componentes React con arrays dinámicos.

## Archivos Modificados

### 1. `/src/app/seller/cotizations/[cotizationId]/[workId]/area-box.tsx`
**Línea 70**
- **ANTES:** `<div key={index} className="grid grid-cols-[1fr,1fr,1fr,50px] gap-2 items-center">`
- **DESPUÉS:** `<div key={itemArea.id || \`temp-${index}\`} className="grid grid-cols-[1fr,1fr,1fr,50px] gap-2 items-center">`
- **Razón:** Usar índice como key causaba pérdida de identidad de componentes al agregar/eliminar items

### 2. `/src/app/seller/cotizations/[cotizationId]/[workId]/termination-box.tsx`
**Línea 174**
- **ANTES:** `<div key={index} className="grid grid-cols-[1fr,1fr,1fr,1fr,1fr,1fr,50px] gap-2 items-center">`
- **DESPUÉS:** `<div key={item.id || \`temp-${index}\`} className="grid grid-cols-[1fr,1fr,1fr,1fr,1fr,1fr,50px] gap-2 items-center">`
- **Razón:** Mismo problema con keys dinámicas

### 3. `/src/app/seller/cotizations/[cotizationId]/[workId]/ajuste-box.tsx`
**Línea 62**
- **ANTES:** `<div key={index} className="flex gap-2 items-center">`
- **DESPUÉS:** `<div key={item.id || \`temp-${index}\`} className="flex gap-2 items-center">`
- **Razón:** Mismo problema con keys dinámicas

### 4. `/src/app/seller/cotizations/[cotizationId]/[workId]/page.tsx`

#### Cambio 4.1: Import de useMemo
**Línea 18**
- **ANTES:** `import { useEffect, useState } from "react"`
- **DESPUÉS:** `import { useEffect, useMemo, useState } from "react"`

#### Cambio 4.2: Optimización con useMemo
**Líneas 97-125**
- **ANTES:** Cálculos directos en cada render:
```javascript
const tramosWithData= tramos.filter((items) => items.length && items.width && items.length > 0 && items.width > 0)
const totalTramosWithData= tramosWithData.reduce((acc, items) => acc + (items.quantity ? items.quantity : 0), 0)
// ... más cálculos similares
```

- **DESPUÉS:** Cálculos memoizados:
```javascript
const tramosWithData = useMemo(() =>
    tramos.filter((items) => items.length && items.width && items.length > 0 && items.width > 0), [tramos])
const totalTramosWithData = useMemo(() =>
    tramosWithData.reduce((acc, items) => acc + (items.quantity ? items.quantity : 0), 0), [tramosWithData])
// ... más cálculos memoizados
```

#### Cambio 4.3: Remover saveCount del useEffect
**Línea 174**
- **ANTES:** `}, [workId, saveCount, isColocacionLoading])`
- **DESPUÉS:** `}, [workId, isColocacionLoading])`
- **Razón:** Evitar recargas innecesarias después de guardar

#### Cambio 4.4: Flag de carga inicial (mejora adicional)
**Línea 86**
- **AGREGADO:** `const [isInitialLoad, setIsInitialLoad] = useState(true)`

**Líneas 177-205**
- **MODIFICADO:** useEffect ahora verifica `isInitialLoad` y solo carga datos la primera vez
- **AGREGADO:** `setIsInitialLoad(false)` al final del useEffect

## Instrucciones para Rollback

### Rollback Completo (todos los cambios):
```bash
# 1. Revertir area-box.tsx
# Cambiar línea 70:
key={itemArea.id || `temp-${index}`}
# POR:
key={index}

# 2. Revertir termination-box.tsx
# Cambiar línea 174:
key={item.id || `temp-${index}`}
# POR:
key={index}

# 3. Revertir ajuste-box.tsx
# Cambiar línea 62:
key={item.id || `temp-${index}`}
# POR:
key={index}

# 4. Revertir page.tsx
# - Remover useMemo del import (línea 18)
# - Quitar todos los useMemo() de líneas 97-125 (volver a cálculos directos)
# - Agregar saveCount de vuelta en línea 174: }, [workId, saveCount, isColocacionLoading])
# - Remover estado isInitialLoad (línea 86)
# - Remover verificación de isInitialLoad del useEffect (línea 178)
# - Remover setIsInitialLoad(false) (línea 203)
```

### Rollback Parcial (solo lo crítico):
Si solo quieres revertir los cambios de keys (causa principal del error de loop infinito):
```bash
# Solo revertir las keys en los 3 archivos box:
# - area-box.tsx línea 70
# - termination-box.tsx línea 174
# - ajuste-box.tsx línea 62
# Cambiar key={item.id || `temp-${index}`} POR key={index}
```

## Notas Importantes
1. **CRÍTICO:** Los cambios de keys son los más importantes. Sin ellos, puede ocurrir un loop infinito.
2. **useMemo** es una optimización de performance, no crítico pero recomendado mantener.
3. **isInitialLoad** resuelve un problema menor de UX (inputs que desaparecen), no crítico.

## Estado del Sistema
- Error de hidratación: **RESUELTO** ✅
- Loop infinito con Date.now(): **CORREGIDO** ✅
- Performance en PCs lentas: **MEJORADO** ✅
- Inputs que desaparecen: **SOLUCIONADO** ✅

## Contacto
Para cualquier problema con estos cambios, revisar el comportamiento al:
1. Ingresar datos rápidamente con TAB
2. Agregar/eliminar items mientras se escribe
3. Verificar en consola errores de "Maximum update depth exceeded"